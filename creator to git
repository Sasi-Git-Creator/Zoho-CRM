import requests
import os
from git import Repo
from datetime import datetime

# === üîß CONFIGURATION ===
ZOHO_ACCESS_TOKEN = "1000.d401c7afb4f7d4f35d9d894de1ac00cb.1659323ee5fac29e6b846e5a28a20d38"
OWNER_NAME = "SASI"
APP_NAME = "crm-function-backup"
REPORT_LINK_NAME = "All_Function_Backups"  # Creator report of the DelugeFunctions form

GITHUB_TOKEN = "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"
GITHUB_REPO = "Sasi-Git-Creator"
LOCAL_CLONE_PATH = "/tmp/deluge_sync"

# === üì° FETCH DATA FROM CREATOR ===
def fetch_deluge_functions():
    print("Fetching Deluge functions from Creator...")
    url = f"https://creator.zoho.in/api/v2/excell/crm-function-backup/report/All_Function_Backups"
    headers = {
        "Authorization": f"Zoho-oauthtoken {ZOHO_ACCESS_TOKEN}"
    }
    response = requests.get(url, headers=headers)
    response.raise_for_status()
    return response.json().get("data", [])

# === üìù SAVE EACH FUNCTION TO FILE ===
def write_functions_to_files(data):
    os.makedirs(LOCAL_CLONE_PATH, exist_ok=True)
    for record in data:
        name = record["Function_Name"].strip().replace(" ", "_")
        code = record["Function_Code"]
        file_path = os.path.join(LOCAL_CLONE_PATH, f"{name}.deluge")
        with open(file_path, "w") as file:
            file.write(code)
    print("Saved all functions locally.")

# === üß¨ GIT COMMIT AND PUSH ===
def push_to_github():
    repo_url = f"https://{GITHUB_TOKEN}@github.com/{GITHUB_REPO}.git"
    if os.path.exists(os.path.join(LOCAL_CLONE_PATH, ".git")):
        repo = Repo(LOCAL_CLONE_PATH)
    else:
        print("Cloning fresh repo...")
        repo = Repo.clone_from(repo_url, LOCAL_CLONE_PATH)

    repo.git.add(A=True)
    repo.index.commit(f"Backup: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    repo.remote().push()
    print("Pushed changes to GitHub.")

# === üöÄ RUN EVERYTHING ===
if __name__ == "__main__":
    data = fetch_deluge_functions()
    write_functions_to_files(data)
    push_to_github()
